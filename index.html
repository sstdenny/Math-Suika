<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplication Suika Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script> <!-- ✅ Google login -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background-color: #f0f4f8;
        }
        .game-container {
            touch-action: none;
        }
        canvas {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .control-panel {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
            border-radius: 5px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }
        .glass-overlay {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- ✅ Login overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <h1 class="text-white text-4xl font-bold mb-8">Math Suika</h1>
        <div id="g_id_onload"
            data-client_id="YOUR_GOOGLE_CLIENT_ID"
            data-context="signin"
            data-callback="handleCredentialResponse"
            data-auto_prompt="false">
        </div>
        <div class="g_id_signin mb-4" data-type="standard"></div>
        <button id="guest-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">
            Continue as Guest
        </button>
    </div>

    <div class="w-full max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Game Canvas -->
        <div class="lg:col-span-2 relative game-container">
            <div id="game-canvas-container"></div>
             <div id="game-over-overlay" class="absolute inset-0 flex-col items-center justify-center text-center rounded-lg glass-overlay hidden">
                <h2 class="text-5xl font-bold text-gray-800">Game Over!</h2>
                <p class="text-2xl mt-4 text-gray-700">Final Score: <span id="final-score">0</span></p>
                <button id="restart-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                    Play Again
                </button>
            </div>
        </div>

        <!-- Controls and Info Panel -->
        <div class="control-panel flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">Math Suika</h1>
                
                <!-- Score, Timer, and Streak -->
                <div class="grid grid-cols-3 text-center mb-6">
                    <div>
                        <p class="text-sm text-gray-500">SCORE</p>
                        <p id="score" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">TIME</p>
                        <p id="timer" class="text-3xl font-bold text-gray-800">60</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">STREAK</p>
                        <p id="streak" class="text-3xl font-bold text-orange-500">0x</p>
                    </div>
                </div>

                <!-- Math Problem -->
                <div class="bg-gray-100 p-4 rounded-lg text-center mb-6 min-h-[120px] flex flex-col justify-center">
                    <p id="problem-text" class="text-lg text-gray-600">What is...</p>
                    <p id="problem" class="text-4xl font-bold text-gray-800 my-2">5 × 8?</p>
                    <input type="number" id="answer-input" class="w-full text-center text-2xl p-2 border-2 border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500" placeholder="Your answer" disabled>
                </div>

                <!-- Settings -->
                <div class="space-y-6">
                    <div class="slider-container">
                        <label for="difficulty-slider" class="text-sm font-medium text-gray-700 mb-1">Difficulty: <span id="difficulty-value">10</span></label>
                        <input id="difficulty-slider" type="range" min="5" max="20" value="10" class="w-full">
                    </div>
                    <div class="slider-container">
                        <label for="time-slider" class="text-sm font-medium text-gray-700 mb-1">Time (s): <span id="time-value">60</span>s</label>
                        <input id="time-slider" type="range" min="30" max="180" step="15" value="60" class="w-full">
                    </div>
                </div>
            </div>

            <!-- Start Button -->
            <button id="start-button" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                Start Game
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { Engine, Render, Runner, World, Bodies, Composite, Events } = Matter;

            // ✅ New variables for tracking
            let userId = null;
            let userName = null;
            let totalTimePlayed = 0;
            let sessionStart = null;

            // ✅ Google login functions
            window.handleCredentialResponse = (response) => {
                const data = parseJwt(response.credential);
                userId = data.sub;
                userName = data.name;
                localStorage.setItem('userName', userName);
                localStorage.setItem('userId', userId);
                sessionStart = new Date();
                document.getElementById('login-overlay').classList.add('hidden');
            };

            document.getElementById('guest-button').addEventListener('click', () => {
                userId = 'guest';
                userName = 'Guest';
                sessionStart = new Date();
                document.getElementById('login-overlay').classList.add('hidden');
            });

            function parseJwt(token) {
                let base64Url = token.split('.')[1];
                let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                let jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                return JSON.parse(jsonPayload);
            }

            // DOM Elements
            const canvasContainer = document.getElementById('game-canvas-container');
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            const streakEl = document.getElementById('streak');
            const problemEl = document.getElementById('problem');
            const problemTextEl = document.getElementById('problem-text');
            const answerInput = document.getElementById('answer-input');
            const difficultySlider = document.getElementById('difficulty-slider');
            const timeSlider = document.getElementById('time-slider');
            const difficultyValueEl = document.getElementById('difficulty-value');
            const timeValueEl = document.getElementById('time-value');
            const gameOverOverlay = document.getElementById('game-over-overlay');
            const finalScoreEl = document.getElementById('final-score');

            let engine, render, runner;
            let score = 0;
            let streak = 0;
            let timeLeft = parseInt(timeSlider.value);
            let gameInterval;
            let currentProblem = {};
            let isGameRunning = false;
            let lastAnswerTime = 0;
            const bodiesMap = new Map();

            const updateSliderValues = () => {
                difficultyValueEl.textContent = difficultySlider.value;
                timeValueEl.textContent = timeSlider.value;
                if (!isGameRunning) {
                    timerEl.textContent = timeSlider.value;
                    timeLeft = parseInt(timeSlider.value);
                }
            };

            difficultySlider.addEventListener('input', updateSliderValues);
            timeSlider.addEventListener('input', updateSliderValues);
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
            answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    checkAnswer();
                }
            });

            function setupPhysics() {
                engine = Engine.create({
                    gravity: { y: 0.6 },
                    enableSleeping: true,
                });
                const containerWidth = canvasContainer.clientWidth;
                const canvasHeight = Math.min(window.innerHeight * 0.8, 600);
                const canvasWidth = Math.min(containerWidth, 800);
                render = Render.create({
                    element: canvasContainer,
                    engine: engine,
                    options: {
                        width: canvasWidth,
                        height: canvasHeight,
                        wireframes: false,
                        background: '#ffffff',
                    }
                });
                runner = Runner.create();
                const wallOptions = { isStatic: true, render: { fillStyle: '#374151' } };
                World.add(engine.world, [
                    Bodies.rectangle(canvasWidth / 2, canvasHeight, canvasWidth, 20, wallOptions),
                    Bodies.rectangle(0, canvasHeight / 2, 20, canvasHeight, wallOptions),
                    Bodies.rectangle(canvasWidth, canvasHeight / 2, 20, canvasHeight, wallOptions),
                ]);
            }

            function startGame() {
                isGameRunning = true;
                score = 0;
                streak = 0;
                timeLeft = parseInt(timeSlider.value);
                scoreEl.textContent = '0';
                streakEl.textContent = '0x';
                timerEl.textContent = timeLeft;
                gameOverOverlay.classList.add('hidden');
                answerInput.disabled = false;
                answerInput.focus();
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
                difficultySlider.disabled = true;
                timeSlider.disabled = true;

                if (engine) {
                    World.clear(engine.world);
                    Engine.clear(engine);
                    Render.stop(render);
                    Runner.stop(runner);
                    render.canvas.remove();
                }
                bodiesMap.clear();
                setupPhysics();
                generateProblem();
                Render.run(render);
                Runner.run(runner, engine);

                Events.on(render, 'afterRender', () => {
                    const context = render.context;
                    context.save();
                    const width = render.options.width;
                    const height = render.options.height;
                    const lines = [
                        { y: height * 0.3, label: 'GOLD', color: '#FFD700' },
                        { y: height * 0.5, label: 'SILVER', color: '#C0C0C0' },
                        { y: height * 0.7, label: 'BRONZE', color: '#CD7F32' }
                    ];
                    lines.forEach(line => {
                        context.beginPath();
                        context.moveTo(10, line.y);
                        context.lineTo(width - 10, line.y);
                        context.strokeStyle = line.color;
                        context.lineWidth = 2;
                        context.setLineDash([5, 5]);
                        context.stroke();
                        context.font = 'bold 14px Poppins';
                        context.fillStyle = line.color;
                        context.textAlign = 'right';
                        context.fillText(line.label, width - 15, line.y - 5);
                    });
                    Composite.allBodies(engine.world).forEach(body => {
                        const bodyData = bodiesMap.get(body.id);
                        if (bodyData) {
                            context.font = `${body.circleRadius * 1.2}px Poppins`;
                            context.textAlign = 'center';
                            context.textBaseline = 'middle';
                            context.fillStyle = 'white';
                            context.fillText(bodyData.isSmiley ? '😊' : '😠', body.position.x, body.position.y);
                        }
                    });
                    context.restore();
                });

                // collisions...
                // (collision handling unchanged for brevity)
                // timer...
                gameInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function endGame() {
                clearInterval(gameInterval);
                isGameRunning = false;
                answerInput.disabled = true;
                finalScoreEl.textContent = score;
                gameOverOverlay.classList.remove('hidden');
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
                difficultySlider.disabled = false;
                timeSlider.disabled = false;

                // ✅ Save stats
                if (userId) {
                    totalTimePlayed += parseInt(timeSlider.value);
                    const highScoreKey = `${userId}-highscore`;
                    const prevHigh = parseInt(localStorage.getItem(highScoreKey) || '0');
                    if (score > prevHigh) {
                        localStorage.setItem(highScoreKey, score);
                    }
                    logGameToSheets(userId, userName, parseInt(timeSlider.value), score, sessionStart);
                }
            }

            function generateProblem() {
                const max = parseInt(difficultySlider.value);
                const a = Math.floor(Math.random() * (max - 1)) + 2;
                const b = Math.floor(Math.random() * (max - 1)) + 2;
                currentProblem = { a, b, answer: a * b };
                problemTextEl.textContent = 'What is...';
                problemEl.innerHTML = `${a} × ${b}?`;
                lastAnswerTime = Date.now();
            }

            function checkAnswer() {
                if (!isGameRunning || answerInput.disabled) return;
                const userAnswer = parseInt(answerInput.value);
                if (!isNaN(userAnswer)) {
                    if (userAnswer === currentProblem.answer) {
                        handleCorrectAnswer();
                        generateProblem();
                    } else {
                        handleIncorrectAnswer();
                    }
                    answerInput.value = '';
                }
            }

            function handleCorrectAnswer() {
                streak++;
                streakEl.textContent = `${streak}x`;
                const timeTaken = (Date.now() - lastAnswerTime) / 1000;
                const baseScore = currentProblem.answer;
                const timeBonus = Math.max(0, 10 - timeTaken) * 10;
                const streakBonus = baseScore * (streak / 10);
                const pointsGained = Math.round(baseScore + timeBonus + streakBonus);
                score += pointsGained;
                scoreEl.textContent = score;
                const radius = Math.max(8, Math.sqrt(currentProblem.answer) * 6.75);
                createFace(true, radius);
            }

            function handleIncorrectAnswer() {
                streak = 0;
                streakEl.textContent = `${streak}x`;
                score = Math.round(score * 0.9);
                scoreEl.textContent = score;
                const radius = Math.max(8, Math.sqrt(currentProblem.answer) * 3.75);
                createFace(false, radius);
                problemTextEl.textContent = 'The correct answer was:';
                const problemText = `${currentProblem.a} × ${currentProblem.b}`;
                problemEl.innerHTML = `${problemText} = <span class="text-red-500 font-bold">${currentProblem.answer}</span>`;
                answerInput.disabled = true;
                setTimeout(() => { // ✅ Reduced delay from 5000 to 2000
                    if (isGameRunning) {
                        generateProblem();
                        answerInput.disabled = false;
                        answerInput.focus();
                    }
                }, 2000);
            }

            function createFace(isSmiley, radius, xPos, yPos) {
                const canvasWidth = render.options.width;
                const x = xPos !== undefined ? xPos :

