<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multiplication Suika Game</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; overflow: hidden; background-color: #f0f4f8; }
canvas { background-color: #ffffff; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
button { cursor:pointer; }
.menu-overlay, .game-container, #game-over-overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
.menu-overlay { background-color:#f0f4f8; flex-direction:column; gap:20px; z-index:50; }
.menu-overlay button { width:200px; padding:10px 20px; font-size:16px; }
.control-panel { position:absolute; top:10px; right:10px; width:250px; background:white; padding:20px; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,0.1); z-index:40; display:flex; flex-direction:column; gap:10px; }
#game-over-overlay { background: rgba(255,255,255,0.8); flex-direction:column; gap:15px; z-index:45; display:none; }
#game-canvas-container { width:100%; height:100%; }
</style>
</head>
<body>
<!-- Start Menu -->
<div id="menuOverlay" class="menu-overlay">
    <h1 class="text-3xl font-bold">Math Suika</h1>
    <div id="gSignInDiv"></div>
    <button id="guestButton">Continue as Guest</button>
</div>

<!-- Game Canvas -->
<div class="game-container">
    <div id="game-canvas-container"></div>
    <div id="game-over-overlay" class="flex-col items-center justify-center text-center rounded-lg glass-overlay">
        <h2 class="text-5xl font-bold text-gray-800">Game Over!</h2>
        <p class="text-2xl mt-4 text-gray-700">Final Score: <span id="final-score">0</span></p>
        <button id="restart-button" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Play Again</button>
    </div>
</div>

<!-- Control Panel -->
<div class="control-panel">
    <div class="grid grid-cols-3 text-center">
        <div><p class="text-sm text-gray-500">SCORE</p><p id="score" class="text-3xl font-bold text-blue-600">0</p></div>
        <div><p class="text-sm text-gray-500">TIME</p><p id="timer" class="text-3xl font-bold text-gray-800">60</p></div>
        <div><p class="text-sm text-gray-500">STREAK</p><p id="streak" class="text-3xl font-bold text-orange-500">0x</p></div>
    </div>
    <div class="bg-gray-100 p-4 rounded-lg text-center my-4">
        <p id="problem-text" class="text-lg text-gray-600">What is...</p>
        <p id="problem" class="text-4xl font-bold text-gray-800 my-2">5 Ã— 8?</p>
        <input type="number" id="answer-input" class="w-full text-center text-2xl p-2 border-2 border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500" placeholder="Your answer" disabled>
    </div>
    <div class="space-y-4">
        <label>Difficulty: <span id="difficulty-value">10</span></label>
        <input id="difficulty-slider" type="range" min="5" max="20" value="10">
        <label>Time (s): <span id="time-value">60</span></label>
        <input id="time-slider" type="range" min="30" max="180" step="15" value="60">
    </div>
    <button id="start-button" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Start Game</button>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/a/macros/smcsd.org/s/AKfycbx50yH4Yzgb7atWeqm4AXaTACoh8SgC2s4n7MsVTbiBzRdjsZGsr9V4jrlLwejUD8Q/exec';
const CLIENT_ID = '396894083200-q1n0mk1sam1qmu6d8njf6sp0v77582cp.apps.googleusercontent.com';

let googleUserName = null;
let sessionStart = null;

window.onload = () => {
    // Initialize Google Sign-In
    google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
        document.getElementById('gSignInDiv'),
        { theme: 'outline', size: 'large', width:200 }
    );
};

// Google login callback
function handleCredentialResponse(response){
    const jwt = response.credential;
    const payload = JSON.parse(atob(jwt.split('.')[1]));
    googleUserName = payload.name;
    startMenuHide();
}

document.getElementById('guestButton').onclick = () => {
    googleUserName = 'Guest';
    startMenuHide();
}

function startMenuHide(){
    document.getElementById('menuOverlay').style.display='none';
    document.getElementById('answer-input').disabled = false;
    sessionStart = new Date();
}

// --- Game Code (Matter.js + Logic) ---
document.addEventListener('DOMContentLoaded', () => {
    const { Engine, Render, Runner, World, Bodies, Composite, Events } = Matter;
    const canvasContainer = document.getElementById('game-canvas-container');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const streakEl = document.getElementById('streak');
    const problemEl = document.getElementById('problem');
    const problemTextEl = document.getElementById('problem-text');
    const answerInput = document.getElementById('answer-input');
    const difficultySlider = document.getElementById('difficulty-slider');
    const timeSlider = document.getElementById('time-slider');
    const difficultyValueEl = document.getElementById('difficulty-value');
    const timeValueEl = document.getElementById('time-value');
    const gameOverOverlay = document.getElementById('game-over-overlay');
    const finalScoreEl = document.getElementById('final-score');

    let engine, render, runner;
    let score=0, streak=0, timeLeft=parseInt(timeSlider.value), gameInterval, currentProblem={}, isGameRunning=false, lastAnswerTime=0;
    const bodiesMap = new Map();

    function updateSliderValues(){
        difficultyValueEl.textContent = difficultySlider.value;
        timeValueEl.textContent = timeSlider.value;
        if(!isGameRunning){ timerEl.textContent = timeSlider.value; timeLeft=parseInt(timeSlider.value);}
    }
    difficultySlider.oninput = updateSliderValues;
    timeSlider.oninput = updateSliderValues;
    startButton.onclick = startGame;
    restartButton.onclick = startGame;
    answerInput.onkeydown = e => { if(e.key==='Enter') checkAnswer(); }

    function setupPhysics(){
        engine = Engine.create({ gravity:{y:0.6}, enableSleeping:true });
        const containerWidth = canvasContainer.clientWidth;
        const canvasHeight = Math.min(window.innerHeight*0.8,600);
        const canvasWidth = Math.min(containerWidth,800);
        render = Render.create({ element: canvasContainer, engine:engine, options:{ width:canvasWidth, height:canvasHeight, wireframes:false, background:'#ffffff'} });
        runner = Runner.create();
        const wallOptions = { isStatic:true, render:{fillStyle:'#374151'} };
        World.add(engine.world, [
            Bodies.rectangle(canvasWidth/2, canvasHeight, canvasWidth, 20, wallOptions),
            Bodies.rectangle(0, canvasHeight/2, 20, canvasHeight, wallOptions),
            Bodies.rectangle(canvasWidth, canvasHeight/2, 20, canvasHeight, wallOptions)
        ]);
    }

    function startGame(){
        if(!sessionStart) sessionStart = new Date();
        isGameRunning=true; score=0; streak=0; timeLeft=parseInt(timeSlider.value);
        scoreEl.textContent='0'; streakEl.textContent='0x'; timerEl.textContent=timeLeft;
        gameOverOverlay.style.display='none';
        answerInput.disabled=false; answerInput.focus();
        startButton.disabled=true; difficultySlider.disabled=true; timeSlider.disabled=true;

        if(engine){
            World.clear(engine.world); Engine.clear(engine); Render.stop(render); Runner.stop(runner); render.canvas.remove();
        }
        bodiesMap.clear();
        setupPhysics(); generateProblem();
        Render.run(render); Runner.run(runner,engine);

        Events.on(render,'afterRender',()=> {
            const context = render.context;
            context.save();
            const width = render.options.width; const height = render.options.height;
            const lines = [
                {y: height*0.3, label:'GOLD', color:'#FFD700'},
                {y: height*0.5, label:'SILVER', color:'#C0C0C0'},
                {y: height*0.7, label:'BRONZE', color:'#CD7F32'}
            ];
            lines.forEach(line=>{
                context.beginPath(); context.moveTo(10,line.y); context.lineTo(width-10,line.y);
                context.strokeStyle=line.color; context.lineWidth=2; context.setLineDash([5,5]); context.stroke();
                context.font='bold 14px Poppins'; context.fillStyle=line.color; context.textAlign='right'; context.fillText(line.label,width-15,line.y-5);
            });
            Composite.allBodies(engine.world).forEach(body=>{
                const bodyData=bodiesMap.get(body.id);
                if(bodyData){
                    context.font=`${body.circleRadius*1.2}px Poppins`;
                    context.textAlign='center'; context.textBaseline='middle'; context.fillStyle='white';
                    context.fillText(bodyData.isSmiley?'ðŸ˜Š':'ðŸ˜ ',body.position.x,body.position.y);
                }
            });
            context.restore();
        });

        Events.on(engine,'collisionStart',(event)=>{
            const pairs = event.pairs; const bodiesToRemove = new Set(); const bodiesToAdd = [];
            pairs.forEach(pair=>{
                if(bodiesToRemove.has(pair.bodyA) || bodiesToRemove.has(pair.bodyB)) return;
                const bodyAData=bodiesMap.get(pair.bodyA.id); const bodyBData=bodiesMap.get(pair.bodyB.id);
                if(bodyAData && bodyBData){
                    if((bodyAData.isSad && bodyBData.isSmiley)||(bodyBData.isSad && bodyAData.isSmiley)){
                        const sadFace=bodyAData.isSad?pair.bodyA:pair.bodyB;
                        const smileyFace=bodyAData.isSmiley?pair.bodyA:pair.bodyB;
                        if(sadFace.circleRadius>smileyFace.circleRadius){
                            bodiesToRemove.add(smileyFace); bodiesToRemove.add(sadFace);
                        }
                    } else if(bodyAData.isSad && bodyBData.isSad){
                        const newRadius=Math.sqrt(Math.pow(pair.bodyA.circleRadius,2)+Math.pow(pair.bodyB.circleRadius,2));
                        const largerFace=pair.bodyA.circleRadius>pair.bodyB.circleRadius?pair.bodyA:pair.bodyB;
                        bodiesToAdd.push({isSmiley:false,radius:newRadius,x:largerFace.position.x,y:largerFace.position.y});
                        bodiesToRemove.add(pair.bodyA); bodiesToRemove.add(pair.bodyB);
                    }
                }
            });
            bodiesToRemove.forEach(b=>{ World.remove(engine.w
